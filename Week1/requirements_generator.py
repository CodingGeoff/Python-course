import os
import ast
import json
import sys
import importlib.metadata
from collections import defaultdict

def get_stdlib_names():
    """è·å–Pythonæ ‡å‡†åº“åˆ—è¡¨ï¼Œç”¨äºè¿‡æ»¤ï¼ˆå¦‚ os, sys, re ä¸ä¼šè¢«å†™å…¥ requirementsï¼‰"""
    if sys.version_info >= (3, 10):
        return sys.stdlib_module_names
    else:
        # å…¼å®¹æ—§ç‰ˆæœ¬ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºç¡€åˆ—è¡¨
        return {
            'os', 'sys', 're', 'math', 'json', 'time', 'datetime', 'random', 
            'collections', 'itertools', 'functools', 'pathlib', 'shutil', 
            'subprocess', 'typing', 'copy', 'io', 'csv', 'warnings'
        }

def get_imports_from_file(file_path):
    """è¯»å–æ–‡ä»¶å¹¶è§£æASTï¼Œæå–å¯¼å…¥çš„æ¨¡å—å"""
    imports = set()
    
    try:
        if file_path.endswith('.ipynb'):
            # å¤„ç† Jupyter Notebook
            with open(file_path, 'r', encoding='utf-8') as f:
                notebook = json.load(f)
                # åªæå–ä»£ç å•å…ƒæ ¼
                code_lines = []
                for cell in notebook.get('cells', []):
                    if cell['cell_type'] == 'code':
                        code_lines.extend(cell.get('source', []))
                content = "".join(code_lines)
        else:
            # å¤„ç† Python è„šæœ¬
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
        
        # è§£ææŠ½è±¡è¯­æ³•æ ‘ (AST)
        tree = ast.parse(content)
        
        for node in ast.walk(tree):
            # å¤„ç† import xxx
            if isinstance(node, ast.Import):
                for alias in node.names:
                    imports.add(alias.name.split('.')[0])
            # å¤„ç† from xxx import yyy
            elif isinstance(node, ast.ImportFrom):
                if node.module:
                    imports.add(node.module.split('.')[0])
                    
    except Exception as e:
        print(f"âš ï¸ è§£æè­¦å‘Š: æ— æ³•è¯»å– {file_path} - {e}")
        
    return imports

def map_import_to_package():
    """å»ºç«‹ å¯¼å…¥å -> å®‰è£…åŒ…å çš„æ˜ å°„ (ä¾‹å¦‚ cv2 -> opencv-python)"""
    mapping = defaultdict(list)
    try:
        # è·å–å½“å‰ç¯å¢ƒæ‰€æœ‰å·²å®‰è£…çš„åŒ…åˆ†å¸ƒ
        packages = importlib.metadata.packages_distributions()
        for import_name, package_names in packages.items():
            for pkg in package_names:
                mapping[import_name].append(pkg)
    except AttributeError:
        print("âŒ æ‚¨çš„ Python ç‰ˆæœ¬è¿‡ä½ï¼Œå»ºè®®å‡çº§åˆ° 3.10+ ä»¥è·å¾—æœ€ä½³æ¢æµ‹æ•ˆæœã€‚")
    return mapping

def generate_robust_requirements():
    print("ğŸ” å¼€å§‹æ·±åº¦æ‰«æå½“å‰ç›®å½•ä¸‹çš„ .py å’Œ .ipynb æ–‡ä»¶...")
    
    # 1. å‡†å¤‡å·¥ä½œ
    target_files = []
    for root, dirs, files in os.walk('.'):
        # æ’é™¤è™šæ‹Ÿç¯å¢ƒç›®å½• (å¸¸è§å‘½å)
        if any(v in root for v in ['venv', '.git', '__pycache__', '.ipynb_checkpoints']):
            continue
        for file in files:
            if file.endswith(('.py', '.ipynb')):
                target_files.append(os.path.join(root, file))
    
    print(f"ğŸ“„ æ‰¾åˆ° {len(target_files)} ä¸ªä»£ç æ–‡ä»¶ã€‚")
    
    # 2. æå–æ‰€æœ‰å¯¼å…¥
    all_imports = set()
    stdlib = get_stdlib_names()
    
    for file in target_files:
        file_imports = get_imports_from_file(file)
        # è¿‡æ»¤æ ‡å‡†åº“ (å¦‚ os, sys) å’Œ ç›¸å¯¹å¯¼å…¥
        clean_imports = {i for i in file_imports if i not in stdlib and not i.startswith('_')}
        all_imports.update(clean_imports)
        
    print(f"ğŸ§© æå–åˆ° {len(all_imports)} ä¸ªç¬¬ä¸‰æ–¹åº“å¼•ç”¨: {all_imports}")

    # 3. æ˜ å°„åˆ°çœŸå®å®‰è£…ç‰ˆæœ¬ (æ ¸å¿ƒæ­¥éª¤)
    import_to_pkg = map_import_to_package()
    final_requirements = {}
    missing_packages = []
    
    for module in all_imports:
        # å°è¯•æŸ¥æ‰¾å¯¹åº”çš„å®‰è£…åŒ…
        package_names = import_to_pkg.get(module)
        
        if package_names:
            # é€šå¸¸å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„åŒ…å
            pkg_name = package_names[0]
            try:
                version = importlib.metadata.version(pkg_name)
                final_requirements[pkg_name] = version
            except importlib.metadata.PackageNotFoundError:
                missing_packages.append(module)
        else:
            # æœ‰äº›åŒ… import åå­—å°±æ˜¯åŒ…åï¼Œä½†æ— æ³•é€šè¿‡ distribution æ‰¾åˆ°ï¼ˆå°‘æ•°æƒ…å†µï¼‰
            # æˆ–è€…è¯¥åŒ…å°šæœªå®‰è£…
            missing_packages.append(module)

    # 4. å†™å…¥æ–‡ä»¶
    output_file = "requirements.txt"
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("# Generated by Auto-Detector\n")
        for pkg, ver in sorted(final_requirements.items()):
            f.write(f"{pkg}=={ver}\n")
            
    # 5. ç»“æœæ±‡æŠ¥
    print("\n" + "="*40)
    print(f"âœ… æˆåŠŸç”Ÿæˆ: {output_file}")
    print("="*40)
    print("ğŸ“¦ åŒ…å«åº“:")
    for pkg, ver in final_requirements.items():
        print(f" - {pkg} == {ver}")
        
    if missing_packages:
        print("\nâš ï¸ è­¦å‘Š: ä»£ç ä¸­å¼•ç”¨äº†ä»¥ä¸‹åº“ï¼Œä½†å½“å‰ç¯å¢ƒæœªæ£€æµ‹åˆ°å®‰è£… (æˆ–æ˜ å°„å¤±è´¥):")
        print(f"   {missing_packages}")
        print("   (åŸå› å¯èƒ½æ˜¯: ä½ æ²¡æœ‰å®‰è£…å®ƒï¼Œæˆ–è€…å®ƒæ˜¯æœ¬åœ°æ–‡ä»¶ import)")

# è¿è¡Œä¸»ç¨‹åº
generate_robust_requirements()